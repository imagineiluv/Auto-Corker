@page "/settings"
@using System.Linq
@using Microsoft.AspNetCore.WebUtilities
@using Corker.Orchestrator.Models
@using Corker.Core.Settings
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService
@inject Corker.Core.Interfaces.ISettingsService SettingsService
@inject Corker.Core.Interfaces.ILLMStatusProvider LlmStatusProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<section class="page-header">
    <div>
        <span class="page-kicker">System</span>
        <h1>Settings</h1>
        <p class="page-subtitle">Configure models, repositories, and agent behavior.</p>
    </div>
    <div class="page-actions">
        <button class="ghost-button" type="button" @onclick="ResetAsync">@_resetLabel</button>
        <button class="primary-button" type="button" @onclick="SaveAsync">@_saveLabel</button>
    </div>
</section>

<section class="tab-shell">
    <div class="tab-list">
        <button class="tab-pill @(IsActive("app"))" type="button" @onclick="@(() => SetActiveTab("app"))">App</button>
        <button class="tab-pill @(IsActive("project"))" type="button"
            @onclick="@(() => SetActiveTab("project"))">Project</button>
        <button class="tab-pill @(IsActive("agents"))" type="button"
            @onclick="@(() => SetActiveTab("agents"))">Agents</button>
    </div>
</section>

<section class="page-content">
    @if (_activeTab == "app")
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Model"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Local LLM configuration and runtime status.</p>
                        </div>
                        <span class="pill @_localLlmStatus">@_localLlmLabel</span>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(async () => await HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Preferences</h3>
                        <p>Appearance and notification preferences.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>Theme</label>
                        <div class="settings-value">
                            <span class="pill">@_themeLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleTheme">Toggle</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Auto Updates</label>
                        <div class="settings-value">
                            <span class="pill @_autoUpdatesClass">@_autoUpdatesLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleAutoUpdates">Manage</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (_activeTab == "project")
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Project"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Repository and sync configuration.</p>
                        </div>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(async () => await HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Git Integrations</h3>
                        <p>Configure GitHub and GitLab connectivity.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>GitHub</label>
                        <div class="settings-value">
                            <span class="pill @_gitHubStatusClass">@_gitHubStatusLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleGitHubConnection">Manage</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>GitLab</label>
                        <div class="settings-value">
                            <span class="pill @_gitLabStatusClass">@_gitLabStatusLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleGitLabConnection">Connect</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Agents"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Configure task execution and validation.</p>
                        </div>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(async () => await HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Notifications</h3>
                        <p>Alerts for reviews, completions, and errors.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>Review Alerts</label>
                        <div class="settings-value">
                            <span class="pill @_reviewAlertsClass">@_reviewAlertsLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleReviewAlerts">Configure</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Failure Alerts</label>
                        <div class="settings-value">
                            <span class="pill @_failureAlertsClass">@_failureAlertsLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleFailureAlerts">Enable</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</section>

@code {
    private string _activeTab = "app";
    private IReadOnlyList<SettingsSection> _sections = Array.Empty<SettingsSection>();
    private AppSettings _appSettings = new();

    private string _localLlmLabel = "Local LLM";
    private string _localLlmStatus = "muted";
    private string _saveLabel = "Save";
    private string _resetLabel = "Reset";
    private string _themeLabel = "Dark";
    private string _autoUpdatesLabel = "Enabled";
    private string _autoUpdatesClass = "green";
    private string _gitHubStatusLabel = "Connected";
    private string _gitHubStatusClass = "green";
    private string _gitLabStatusLabel = "Not connected";
    private string _gitLabStatusClass = string.Empty;
    private string _reviewAlertsLabel = "Enabled";
    private string _reviewAlertsClass = "green";
    private string _failureAlertsLabel = "Muted";
    private string _failureAlertsClass = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
        ApplyQueryTab();
    }

    private void ApplyQueryTab()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("tab", out var tabValue))
        {
            var requested = tabValue.ToString();
            if (requested is "app" or "project" or "agents")
            {
                _activeTab = requested;
            }
        }
    }

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
    }

    private string IsActive(string tab)
    {
        return _activeTab == tab ? "active" : string.Empty;
    }

    private async Task LoadSettingsAsync()
    {
        _appSettings = await SettingsService.LoadAsync();

        // Refresh base status from DashboardService
        var status = await DashboardService.GetLocalLlmStatusAsync();
        _localLlmLabel = status.IsAvailable ? "Local LLM Ready" : "Local LLM Missing";
        _localLlmStatus = status.IsAvailable ? "green" : "warning";

        // Map AppSettings to View Models manually or via DashboardService if updated
        // For simplicity, we use DashboardService's initial view then override with local state
        _sections = await DashboardService.GetSettingsAsync();

        // Override with real values from _appSettings
        UpdateViewModelFromSettings();
    }

    private void UpdateViewModelFromSettings()
    {
        UpdateSettingItem("Model", "Model Path", c => c with { Value = ShortenPath(_appSettings.ModelPath), ValueClass = string.IsNullOrEmpty(_appSettings.ModelPath) ? "warning" : "muted" });
        UpdateSettingItem("Model", "Context Window", c => c with { Value = _appSettings.ContextWindow.ToString() });
        UpdateSettingItem("Project", "Repository Path", c => c with { Value = ShortenPath(_appSettings.RepoPath), ValueClass = string.IsNullOrEmpty(_appSettings.RepoPath) ? "warning" : "muted" });
        UpdateSettingItem("Project", "Auto Sync", c => c with { Value = _appSettings.AutoSync ? "Enabled" : "Paused", ValueClass = _appSettings.AutoSync ? "green" : "muted" });
        UpdateSettingItem("Agents", "Validation Mode", c => c with { Value = _appSettings.Sandboxed ? "Sandboxed" : "Permissive", ValueClass = _appSettings.Sandboxed ? "muted" : "warning" });
        UpdateSettingItem("Agents", "Parallel Tasks", c => c with { Value = $"{_appSettings.MaxParallelTasks} max" });

        _themeLabel = _appSettings.Theme;
        _autoUpdatesLabel = _appSettings.AutoUpdates ? "Enabled" : "Paused";
        _autoUpdatesClass = _appSettings.AutoUpdates ? "green" : "muted";
        _reviewAlertsLabel = _appSettings.ReviewAlerts ? "Enabled" : "Muted";
        _reviewAlertsClass = _appSettings.ReviewAlerts ? "green" : string.Empty;
        _failureAlertsLabel = _appSettings.FailureAlerts ? "Enabled" : "Muted";
        _failureAlertsClass = _appSettings.FailureAlerts ? "green" : string.Empty;
    }

    private string ShortenPath(string path)
    {
        if (string.IsNullOrEmpty(path)) return "Not Set";
        if (path.Length > 30) return "..." + path.Substring(path.Length - 27);
        return path;
    }

    private async Task ResetAsync()
    {
        _appSettings = new AppSettings(); // Defaults
        await SaveAsync();
        await LoadSettingsAsync();
        _saveLabel = "Save";
        _resetLabel = "Reset";
    }

    private async Task SaveAsync()
    {
        await SettingsService.SaveAsync(_appSettings);
        _saveLabel = "Saved";
        await Task.Delay(2000);
        _saveLabel = "Save";
    }

    private async Task HandleSettingAction(string sectionTitle, SettingsItem item)
    {
        if (sectionTitle == "Model" && item.Label == "Model Path")
        {
            var newPath = await JS.InvokeAsync<string>("prompt", "Enter path to GGUF model:", _appSettings.ModelPath);
            if (!string.IsNullOrWhiteSpace(newPath))
            {
                _appSettings.ModelPath = newPath;
            }
        }
        else if (sectionTitle == "Project" && item.Label == "Repository Path")
        {
            var newPath = await JS.InvokeAsync<string>("prompt", "Enter git repository path:", _appSettings.RepoPath);
            if (!string.IsNullOrWhiteSpace(newPath))
            {
                _appSettings.RepoPath = newPath;
            }
        }
        else if (sectionTitle == "Model" && item.Label == "Context Window")
        {
            _appSettings.ContextWindow = _appSettings.ContextWindow == 4096 ? 8192 : 4096;
        }
        else if (sectionTitle == "Project" && item.Label == "Auto Sync")
        {
            _appSettings.AutoSync = !_appSettings.AutoSync;
        }
        else if (sectionTitle == "Agents" && item.Label == "Validation Mode")
        {
            _appSettings.Sandboxed = !_appSettings.Sandboxed;
        }
        else if (sectionTitle == "Agents" && item.Label == "Parallel Tasks")
        {
            _appSettings.MaxParallelTasks = _appSettings.MaxParallelTasks >= 4 ? 1 : _appSettings.MaxParallelTasks + 1;
        }

        UpdateViewModelFromSettings();
    }

    private void UpdateSettingItem(string sectionTitle, string itemLabel, Func<SettingsItem, SettingsItem> update)
    {
        _sections = _sections.Select(section =>
        {
            if (section.Title != sectionTitle) return section;
            var updatedItems = section.Items.Select(item => item.Label == itemLabel ? update(item) : item).ToList();
            return section with { Items = updatedItems };
        }).ToList();
    }

    private void ToggleTheme()
    {
        _appSettings.Theme = _appSettings.Theme == "Dark" ? "Light" : "Dark";
        UpdateViewModelFromSettings();
    }

    private void ToggleAutoUpdates()
    {
        _appSettings.AutoUpdates = !_appSettings.AutoUpdates;
        UpdateViewModelFromSettings();
    }

    // Mocks for GitHub/GitLab as they are not in AppSettings yet
    private void ToggleGitHubConnection()
    {
        var connected = _gitHubStatusLabel == "Connected";
        _gitHubStatusLabel = connected ? "Disconnected" : "Connected";
        _gitHubStatusClass = connected ? "warning" : "green";
    }

    private void ToggleGitLabConnection()
    {
        var connected = _gitLabStatusLabel == "Connected";
        _gitLabStatusLabel = connected ? "Not connected" : "Connected";
        _gitLabStatusClass = connected ? string.Empty : "green";
    }

    private void ToggleReviewAlerts()
    {
        _appSettings.ReviewAlerts = !_appSettings.ReviewAlerts;
        UpdateViewModelFromSettings();
    }

    private void ToggleFailureAlerts()
    {
        _appSettings.FailureAlerts = !_appSettings.FailureAlerts;
        UpdateViewModelFromSettings();
    }
}
