@page "/settings"
@using System.Linq
@using Corker.Orchestrator.Models
@using Corker.Core.Settings
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService
@inject Corker.Core.Interfaces.ISettingsService SettingsService
@inject Corker.Core.Interfaces.ILLMStatusProvider LlmStatusProvider
@inject NavigationManager NavigationManager

<section class="page-header">
    <div>
        <span class="page-kicker">System</span>
        <h1>Settings</h1>
        <p class="page-subtitle">Configure models, repositories, and agent behavior.</p>
    </div>
    <div class="page-actions">
        <button class="ghost-button" type="button" @onclick="ResetAsync">@_resetLabel</button>
        <button class="primary-button" type="button" @onclick="SaveAsync">@_saveLabel</button>
    </div>
</section>

<section class="tab-shell">
    <div class="tab-list">
        <button class="tab-pill @(IsActive("app"))" type="button" @onclick="@(() => SetActiveTab("app"))">App</button>
        <button class="tab-pill @(IsActive("project"))" type="button"
            @onclick="@(() => SetActiveTab("project"))">Project</button>
        <button class="tab-pill @(IsActive("agents"))" type="button"
            @onclick="@(() => SetActiveTab("agents"))">Agents</button>
    </div>
</section>

<section class="page-content">
    @if (_activeTab == "app")
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Model"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Local LLM configuration and runtime status.</p>
                        </div>
                        <span class="pill @_localLlmStatus">@_localLlmLabel</span>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(() => HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Preferences</h3>
                        <p>Appearance and notification preferences.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>Theme</label>
                        <div class="settings-value">
                            <span class="pill">@_appSettings.Theme</span>
                            <button class="ghost-button" type="button" @onclick="ToggleTheme">Toggle</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Auto Updates</label>
                        <div class="settings-value">
                            <span class="pill @(_appSettings.AutoUpdates ? "green" : "muted")">@(_appSettings.AutoUpdates ? "Enabled" : "Paused")</span>
                            <button class="ghost-button" type="button" @onclick="ToggleAutoUpdates">Manage</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (_activeTab == "project")
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Project"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Repository and sync configuration.</p>
                        </div>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(() => HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Git Integrations</h3>
                        <p>Configure GitHub and GitLab connectivity.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>GitHub</label>
                        <div class="settings-value">
                            <span class="pill @_gitHubStatusClass">@_gitHubStatusLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleGitHubConnection">Manage</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>GitLab</label>
                        <div class="settings-value">
                            <span class="pill @_gitLabStatusClass">@_gitLabStatusLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleGitLabConnection">Connect</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Agents"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Configure task execution and validation.</p>
                        </div>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(() => HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Notifications</h3>
                        <p>Alerts for reviews, completions, and errors.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>Review Alerts</label>
                        <div class="settings-value">
                            <span class="pill @(_appSettings.ReviewAlerts ? "green" : "")">@(_appSettings.ReviewAlerts ? "Enabled" : "Muted")</span>
                            <button class="ghost-button" type="button" @onclick="ToggleReviewAlerts">Configure</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Failure Alerts</label>
                        <div class="settings-value">
                            <span class="pill @(_appSettings.FailureAlerts ? "green" : "")">@(_appSettings.FailureAlerts ? "Enabled" : "Muted")</span>
                            <button class="ghost-button" type="button" @onclick="ToggleFailureAlerts">Enable</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</section>

@code {
    private string _activeTab = "app";
    private IReadOnlyList<SettingsSection> _sections = Array.Empty<SettingsSection>();
    private AppSettings _appSettings = new();

    private string _localLlmLabel = "Local LLM";
    private string _localLlmStatus = "muted";
    private string _saveLabel = "Save";
    private string _resetLabel = "Reset";

    // These specific GitHub/GitLab statuses might still need real service backing later,
    // but for now we keep them as local state or mock since AppSettings doesn't strictly hold them yet.
    private string _gitHubStatusLabel = "Connected";
    private string _gitHubStatusClass = "green";
    private string _gitLabStatusLabel = "Not connected";
    private string _gitLabStatusClass = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();

        // Refresh base status from DashboardService (e.g. LLM status which is runtime, not config)
        var status = await DashboardService.GetLocalLlmStatusAsync();
        _localLlmLabel = status.IsAvailable ? "Local LLM Ready" : "Local LLM Missing";
        _localLlmStatus = status.IsAvailable ? "green" : "warning";

        ApplyQueryTab();
    }

    private async Task LoadSettingsAsync()
    {
        _appSettings = await SettingsService.LoadAsync();
        RefreshSections();
    }

    private void RefreshSections()
    {
        // Rebuild the sections based on current _appSettings
        // This ensures the UI reflects the real model state

        var localLlmLabel = LlmStatusProvider.IsAvailable ? "Local LLM (Ready)" : "Local LLM (Missing)";
        var statusClass = LlmStatusProvider.IsAvailable ? "green" : "warning";

        _sections = new List<SettingsSection>
        {
            new("Model", new List<SettingsItem>
            {
                new("Provider", localLlmLabel, statusClass, "Details"),
                new("Model Path", _appSettings.ModelPath, "muted", "Browse"),
                new("Context Window", _appSettings.ContextWindow.ToString(), "muted", "Adjust")
            }),
            new("Project", new List<SettingsItem>
            {
                new("Repository Path", string.IsNullOrEmpty(_appSettings.RepoPath) ? "/repos/corker" : _appSettings.RepoPath, "muted", "Browse"),
                new("Auto Sync", _appSettings.AutoSync ? "Enabled" : "Paused", _appSettings.AutoSync ? "green" : "muted", "Configure")
            }),
            new("Agents", new List<SettingsItem>
            {
                new("Validation Mode", _appSettings.Sandboxed ? "Sandboxed" : "Permissive", _appSettings.Sandboxed ? "warning" : "muted", "Edit"),
                new("Parallel Tasks", $"{_appSettings.MaxParallelTasks} max", "muted", "Adjust")
            })
        };
    }

    private void ApplyQueryTab()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = ParseQuery(uri.Query);
        if (query.TryGetValue("tab", out var tabValue))
        {
            var requested = tabValue;
            if (requested is "app" or "project" or "agents")
            {
                _activeTab = requested;
            }
        }
    }

    private Dictionary<string, string> ParseQuery(string queryString)
    {
        var query = new Dictionary<string, string>();
        if (string.IsNullOrEmpty(queryString) || !queryString.StartsWith("?"))
            return query;
        var pairs = queryString.Substring(1).Split('&');
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=');
            if (parts.Length == 2)
            {
                query[Uri.UnescapeDataString(parts[0])] = Uri.UnescapeDataString(parts[1]);
            }
        }
        return query;
    }

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
    }

    private string IsActive(string tab)
    {
        return _activeTab == tab ? "active" : string.Empty;
    }

    private async Task ResetAsync()
    {
        await LoadSettingsAsync();
        _saveLabel = "Save";
        _resetLabel = "Reset";
    }

    private async Task SaveAsync()
    {
        await SettingsService.SaveAsync(_appSettings);
        _saveLabel = "Saved";
        _resetLabel = "Reset";

        // Reload to ensure everything is consistent
        await LoadSettingsAsync();
    }

    private void HandleSettingAction(string sectionTitle, SettingsItem item)
    {
        if (sectionTitle == "Model" && item.Label == "Context Window")
        {
            _appSettings.ContextWindow = _appSettings.ContextWindow == 4096 ? 8192 : 4096;
            RefreshSections();
            _saveLabel = "Save*";
            return;
        }

        if (sectionTitle == "Model" && item.Label == "Model Path")
        {
            // Simulating a file picker or reset
             _appSettings.ModelPath = _appSettings.ModelPath == "/models/lfm2.gguf" ? "/models/corker.gguf" : "/models/lfm2.gguf";
            RefreshSections();
            _saveLabel = "Save*";
            return;
        }

        if (sectionTitle == "Project" && item.Label == "Auto Sync")
        {
            _appSettings.AutoSync = !_appSettings.AutoSync;
            RefreshSections();
            _saveLabel = "Save*";
            return;
        }

        if (sectionTitle == "Project" && item.Label == "Repository Path")
        {
            // Simulate changing path
            _appSettings.RepoPath = "/home/user/new-repo";
            RefreshSections();
            _saveLabel = "Save*";
            return;
        }

        if (sectionTitle == "Agents" && item.Label == "Validation Mode")
        {
            _appSettings.Sandboxed = !_appSettings.Sandboxed;
            RefreshSections();
            _saveLabel = "Save*";
            return;
        }

        if (sectionTitle == "Agents" && item.Label == "Parallel Tasks")
        {
            _appSettings.MaxParallelTasks = _appSettings.MaxParallelTasks >= 4 ? 1 : _appSettings.MaxParallelTasks + 1;
            RefreshSections();
            _saveLabel = "Save*";
            return;
        }
    }

    private void ToggleTheme()
    {
        _appSettings.Theme = _appSettings.Theme == "Dark" ? "Light" : "Dark";
        _saveLabel = "Save*";
    }

    private void ToggleAutoUpdates()
    {
        _appSettings.AutoUpdates = !_appSettings.AutoUpdates;
        _saveLabel = "Save*";
    }

    private void ToggleReviewAlerts()
    {
        _appSettings.ReviewAlerts = !_appSettings.ReviewAlerts;
        _saveLabel = "Save*";
    }

    private void ToggleFailureAlerts()
    {
        _appSettings.FailureAlerts = !_appSettings.FailureAlerts;
        _saveLabel = "Save*";
    }

    // Mock toggles for GitHub/GitLab until those are in AppSettings or a separate service
    private void ToggleGitHubConnection()
    {
        var connected = _gitHubStatusLabel == "Connected";
        _gitHubStatusLabel = connected ? "Disconnected" : "Connected";
        _gitHubStatusClass = connected ? "warning" : "green";
    }

    private void ToggleGitLabConnection()
    {
        var connected = _gitLabStatusLabel == "Connected";
        _gitLabStatusLabel = connected ? "Not connected" : "Connected";
        _gitLabStatusClass = connected ? string.Empty : "green";
    }
}
