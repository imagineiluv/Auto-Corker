@page "/settings"
@using System.Linq
@using Microsoft.AspNetCore.WebUtilities
@using Corker.Orchestrator.Models
@using Corker.Core.Settings
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService
@inject Corker.Core.Interfaces.ISettingsService SettingsService
@inject Corker.Core.Interfaces.ILLMStatusProvider LlmStatusProvider
@inject NavigationManager NavigationManager

<section class="page-header">
    <div>
        <span class="page-kicker">System</span>
        <h1>Settings</h1>
        <p class="page-subtitle">Configure models, repositories, and agent behavior.</p>
    </div>
    <div class="page-actions">
        <button class="ghost-button" type="button" @onclick="ResetAsync">@_resetLabel</button>
        <button class="primary-button" type="button" @onclick="SaveAsync">@_saveLabel</button>
    </div>
</section>

<section class="tab-shell">
    <div class="tab-list">
        <button class="tab-pill @(IsActive("app"))" type="button" @onclick="@(() => SetActiveTab("app"))">App</button>
        <button class="tab-pill @(IsActive("project"))" type="button"
            @onclick="@(() => SetActiveTab("project"))">Project</button>
        <button class="tab-pill @(IsActive("agents"))" type="button"
            @onclick="@(() => SetActiveTab("agents"))">Agents</button>
    </div>
</section>

<section class="page-content">
    @if (_activeTab == "app")
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Model"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Local LLM configuration and runtime status.</p>
                        </div>
                        <span class="pill @_localLlmStatus">@_localLlmLabel</span>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(() => HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Preferences</h3>
                        <p>Appearance and notification preferences.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>Theme</label>
                        <div class="settings-value">
                            <span class="pill">@_themeLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleTheme">Toggle</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Auto Updates</label>
                        <div class="settings-value">
                            <span class="pill @_autoUpdatesClass">@_autoUpdatesLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleAutoUpdates">Manage</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (_activeTab == "project")
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Project"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Repository and sync configuration.</p>
                        </div>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(() => HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Git Integrations</h3>
                        <p>Configure GitHub and GitLab connectivity.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>GitHub</label>
                        <div class="settings-value">
                            <span class="pill @_gitHubStatusClass">@_gitHubStatusLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleGitHubConnection">Manage</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>GitLab</label>
                        <div class="settings-value">
                            <span class="pill @_gitLabStatusClass">@_gitLabStatusLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleGitLabConnection">Connect</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="settings-grid">
            @foreach (var setting in _sections.Where(section => section.Title == "Agents"))
            {
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h3>@setting.Title</h3>
                            <p>Configure task execution and validation.</p>
                        </div>
                    </div>
                    <div class="panel-body">
                        @foreach (var item in setting.Items)
                        {
                            <div class="settings-row">
                                <label>@item.Label</label>
                                <div class="settings-value">
                                    <span class="pill @item.ValueClass">@item.Value</span>
                                    <button class="ghost-button" type="button"
                                        @onclick="@(() => HandleSettingAction(setting.Title, item))">@item.ActionLabel</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Notifications</h3>
                        <p>Alerts for reviews, completions, and errors.</p>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="settings-row">
                        <label>Review Alerts</label>
                        <div class="settings-value">
                            <span class="pill @_reviewAlertsClass">@_reviewAlertsLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleReviewAlerts">Configure</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Failure Alerts</label>
                        <div class="settings-value">
                            <span class="pill @_failureAlertsClass">@_failureAlertsLabel</span>
                            <button class="ghost-button" type="button" @onclick="ToggleFailureAlerts">Enable</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</section>

@code {
    private string _activeTab = "app";
    private IReadOnlyList<SettingsSection> _sections = Array.Empty<SettingsSection>();
    private AppSettings _appSettings = new();

    private string _localLlmLabel = "Local LLM";
    private string _localLlmStatus = "muted";
    private string _saveLabel = "Save";
    private string _resetLabel = "Reset";
    private string _themeLabel = "Dark";
    private string _autoUpdatesLabel = "Enabled";
    private string _autoUpdatesClass = "green";
    private string _gitHubStatusLabel = "Connected";
    private string _gitHubStatusClass = "green";
    private string _gitLabStatusLabel = "Not connected";
    private string _gitLabStatusClass = string.Empty;
    private string _reviewAlertsLabel = "Enabled";
    private string _reviewAlertsClass = "green";
    private string _failureAlertsLabel = "Muted";
    private string _failureAlertsClass = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();

        // Refresh base status from DashboardService (e.g. LLM status which is runtime, not config)
        var status = await DashboardService.GetLocalLlmStatusAsync();
        _localLlmLabel = status.IsAvailable ? "Local LLM Ready" : "Local LLM Missing";
        _localLlmStatus = status.IsAvailable ? "green" : "warning";
        ApplyQueryTab();
    }

    private void ApplyQueryTab()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("tab", out var tabValue))
        {
            var requested = tabValue.ToString();
            if (requested is "app" or "project" or "agents")
            {
                _activeTab = requested;
            }
        }
    }

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
    }

    private string IsActive(string tab)
    {
        return _activeTab == tab ? "active" : string.Empty;
    }

    private async Task LoadSettingsAsync()
    {
        _sections = await DashboardService.GetSettingsAsync();
    }

    private async Task ResetAsync()
    {
        _sections = await DashboardService.GetSettingsAsync();
        _saveLabel = "Save";
        _resetLabel = "Reset";
        _themeLabel = "Dark";
        _autoUpdatesLabel = "Enabled";
        _autoUpdatesClass = "green";
        _gitHubStatusLabel = "Connected";
        _gitHubStatusClass = "green";
        _gitLabStatusLabel = "Not connected";
        _gitLabStatusClass = string.Empty;
        _reviewAlertsLabel = "Enabled";
        _reviewAlertsClass = "green";
        _failureAlertsLabel = "Muted";
        _failureAlertsClass = string.Empty;
    }

    private Task SaveAsync()
    {
        _saveLabel = "Saved";
        _resetLabel = "Reset";
        return Task.CompletedTask;
    }

    private void HandleSettingAction(string sectionTitle, SettingsItem item)
    {
        if (sectionTitle == "Model" && item.Label == "Provider")
        {
            UpdateSettingItem(sectionTitle, item.Label, current => current with { Value = "Local LLM (Verified)", ValueClass = "green" });
            return;
        }

        if (sectionTitle == "Model" && item.Label == "Model Path")
        {
            UpdateSettingItem(sectionTitle, item.Label, current => current with { Value = "/models/corker.gguf", ValueClass = "muted" });
            return;
        }

        if (sectionTitle == "Model" && item.Label == "Context Window")
        {
            var updatedValue = item.Value == "4096" ? "8192" : "4096";
            UpdateSettingItem(sectionTitle, item.Label, current => current with { Value = updatedValue, ValueClass = "muted" });
            return;
        }

        if (sectionTitle == "Project" && item.Label == "Repository Path")
        {
            UpdateSettingItem(sectionTitle, item.Label, current => current with { Value = "/repos/auto-claude", ValueClass = "muted" });
            return;
        }

        if (sectionTitle == "Project" && item.Label == "Auto Sync")
        {
            var enabled = item.Value == "Enabled";
            UpdateSettingItem(sectionTitle, item.Label, current => current with
            {
                Value = enabled ? "Paused" : "Enabled",
                ValueClass = enabled ? "muted" : "green"
            });
            return;
        }

        if (sectionTitle == "Agents" && item.Label == "Validation Mode")
        {
            var sandboxed = item.Value == "Sandboxed";
            UpdateSettingItem(sectionTitle, item.Label, current => current with
            {
                Value = sandboxed ? "Permissive" : "Sandboxed",
                ValueClass = sandboxed ? "muted" : "warning"
            });
            return;
        }

        if (sectionTitle == "Agents" && item.Label == "Parallel Tasks")
        {
            var updatedValue = item.Value.Contains("3") ? "4 max" : "3 max";
            UpdateSettingItem(sectionTitle, item.Label, current => current with { Value = updatedValue, ValueClass = "muted" });
        }
    }

    private void UpdateSettingItem(string sectionTitle, string itemLabel, Func<SettingsItem, SettingsItem> update)
    {
        _sections = _sections.Select(section =>
        {
            if (section.Title != sectionTitle)
            {
                return section;
            }

            var updatedItems = section.Items.Select(item => item.Label == itemLabel ? update(item) : item).ToList();
            return section with { Items = updatedItems };
        }).ToList();
    }

    private void ToggleTheme()
    {
        _themeLabel = _themeLabel == "Dark" ? "Light" : "Dark";
    }

    private void ToggleAutoUpdates()
    {
        var enabled = _autoUpdatesLabel == "Enabled";
        _autoUpdatesLabel = enabled ? "Paused" : "Enabled";
        _autoUpdatesClass = enabled ? "muted" : "green";
    }

    private void ToggleGitHubConnection()
    {
        var connected = _gitHubStatusLabel == "Connected";
        _gitHubStatusLabel = connected ? "Disconnected" : "Connected";
        _gitHubStatusClass = connected ? "warning" : "green";
    }

    private void ToggleGitLabConnection()
    {
        var connected = _gitLabStatusLabel == "Connected";
        _gitLabStatusLabel = connected ? "Not connected" : "Connected";
        _gitLabStatusClass = connected ? string.Empty : "green";
    }

    private void ToggleReviewAlerts()
    {
        var enabled = _reviewAlertsLabel == "Enabled";
        _reviewAlertsLabel = enabled ? "Muted" : "Enabled";
        _reviewAlertsClass = enabled ? string.Empty : "green";
    }

    private void ToggleFailureAlerts()
    {
        var muted = _failureAlertsLabel == "Muted";
        _failureAlertsLabel = muted ? "Enabled" : "Muted";
        _failureAlertsClass = muted ? "green" : string.Empty;
    }
}
