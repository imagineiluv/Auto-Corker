@page "/"
@using Corker.Core.Entities
@using Corker.Orchestrator.Models
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService

<section class="board-header">
    <div class="board-title">
        <span class="board-project">autonomous-coding</span>
        <h1>Kanban Board</h1>
        <p class="page-subtitle">Track autonomous tasks across planning, execution, and review.</p>
    </div>
    <div class="board-actions">
        <label class="toggle">
            <input type="checkbox" @bind="_showArchived" />
            <span>Show archived</span>
        </label>
        <button class="ghost-button" type="button" @onclick="ReloadAsync">Filter</button>
        <button class="primary-button" type="button" @onclick="CreateTaskAsync">+ New Task</button>
    </div>
</section>

<section class="kanban-board">
    @foreach (var column in _columns)
    {
        <div class="kanban-column @GetColumnClass(column.Key)">
            <header class="kanban-column-header">
                <div class="column-title">
                    <h2>@column.Title</h2>
                    <span class="column-count-badge">@column.Tasks.Count</span>
                </div>
                @if (column.Key == "backlog")
                {
                    <div class="column-actions">
                        <button class="icon-button" type="button" @onclick="CreateTaskAsync">+</button>
                    </div>
                }
            </header>

            @if (column.Tasks.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">📭</div>
                    <p>No tasks yet</p>
                    <span>Add a task to @column.Title</span>
                </div>
            }
            else
            {
                @foreach (var task in column.Tasks)
                {
                    <article class="task-card">
                        <div class="task-header">
                            <div class="task-title">@task.Title</div>
                            <span class="pill @task.StatusClass">@task.StatusLabel</span>
                        </div>
                        <p class="task-body">@task.Description</p>
                        @if (task.Progress > 0 && column.Key == "in-progress")
                        {
                            <div class="task-progress">
                                <span>Progress</span>
                                <span>@task.Progress%</span>
                            </div>
                            <div class="progress-bar">
                                <span style="width: @task.Progress%"></span>
                            </div>
                        }
                        <div class="task-footer">
                            <div class="task-tags">
                                @foreach (var tag in task.Tags)
                                {
                                    <span class="pill muted">@tag</span>
                                }
                            </div>
                            <span class="task-time">@task.TimeLabel</span>
                        </div>
                        <div class="task-footer">
                            <span class="pill">@task.Owner</span>
                            <button class="ghost-button" type="button" @onclick="() => MoveTaskAsync(task)">Next</button>
                        </div>
                    </article>
                }
            }
        </div>
    }
</section>

@code {
    private IReadOnlyList<KanbanColumn> _columns = Array.Empty<KanbanColumn>();
    private bool _showArchived;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _columns = await DashboardService.GetKanbanAsync();
    }

    private async Task CreateTaskAsync()
    {
        await DashboardService.CreateTaskAsync("New Task", "Describe the next automation task.");
        await ReloadAsync();
    }

    private async Task MoveTaskAsync(TaskCard task)
    {
        var nextStatus = task.Status switch
        {
            Corker.Core.Entities.TaskStatus.Pending => Corker.Core.Entities.TaskStatus.InProgress,
            Corker.Core.Entities.TaskStatus.InProgress => Corker.Core.Entities.TaskStatus.Review,
            Corker.Core.Entities.TaskStatus.Review => Corker.Core.Entities.TaskStatus.Done,
            _ => Corker.Core.Entities.TaskStatus.Done
        };

        await DashboardService.UpdateTaskStatusAsync(task.Id, nextStatus);
        await ReloadAsync();
    }

    private static string GetColumnClass(string columnKey)
    {
        return columnKey switch
        {
            "backlog" => "planning",
            "in-progress" => "in-progress",
            "ai-review" => "ai-review",
            "human-review" => "human-review",
            "done" => "done",
            _ => "planning"
        };
    }
}
