@page "/"
@using Corker.Core.Entities
@using Corker.Core.Interfaces
@inject IAgentService AgentService
@inject ITaskRepository TaskRepository
@implements IDisposable

<PageTitle>Kanban Board</PageTitle>

<h1>Kanban Board</h1>

<div class="kanban-container">
    <div class="column">
        <h3>Backlog</h3>
        <div class="task-list" ondragover="event.preventDefault();" @ondrop='() => HandleDrop(Corker.Core.Entities.TaskStatus.Pending)'>
            @foreach (var task in Tasks.Where(t => t.Status == Corker.Core.Entities.TaskStatus.Pending || t.Status == Corker.Core.Entities.TaskStatus.Failed))
            {
                <div class="card task-card mb-2" draggable="true" @ondragstart="() => HandleDragStart(task)">
                    <div class="card-body">
                        <h5 class="card-title">@task.Title</h5>
                        <p class="card-text">@task.Description</p>
                        @if(task.Status == Corker.Core.Entities.TaskStatus.Failed)
                        {
                            <span class="badge bg-danger">Failed</span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="column">
        <h3>In Progress</h3>
        <div class="task-list" ondragover="event.preventDefault();" @ondrop='() => HandleDrop(Corker.Core.Entities.TaskStatus.InProgress)'>
            @foreach (var task in Tasks.Where(t => t.Status == Corker.Core.Entities.TaskStatus.InProgress))
            {
                <div class="card task-card mb-2" draggable="true" @ondragstart="() => HandleDragStart(task)">
                    <div class="card-body">
                        <h5 class="card-title">@task.Title</h5>
                        <p class="card-text">@task.Description</p>
                        <span class="badge bg-primary">Active</span>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="column">
        <h3>Review</h3>
        <div class="task-list" ondragover="event.preventDefault();" @ondrop='() => HandleDrop(Corker.Core.Entities.TaskStatus.Review)'>
            @foreach (var task in Tasks.Where(t => t.Status == Corker.Core.Entities.TaskStatus.Review))
            {
                <div class="card task-card mb-2" draggable="true" @ondragstart="() => HandleDragStart(task)">
                    <div class="card-body">
                        <h5 class="card-title">@task.Title</h5>
                        <p class="card-text">@task.Description</p>
                        <span class="badge bg-warning text-dark">Review</span>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="column">
        <h3>Done</h3>
        <div class="task-list" ondragover="event.preventDefault();" @ondrop='() => HandleDrop(Corker.Core.Entities.TaskStatus.Done)'>
            @foreach (var task in Tasks.Where(t => t.Status == Corker.Core.Entities.TaskStatus.Done))
            {
                <div class="card task-card mb-2" draggable="true" @ondragstart="() => HandleDragStart(task)">
                    <div class="card-body">
                        <h5 class="card-title">@task.Title</h5>
                        <p class="card-text">@task.Description</p>
                        <span class="badge bg-success">Done</span>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<button class="btn btn-primary mt-3" @onclick="CreateNewTask">New Task</button>

@code {
    private List<AgentTask> Tasks = new();
    private AgentTask? DraggedTask;

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
        AgentService.OnTaskUpdated += HandleTaskUpdate;
    }

    private void HandleTaskUpdate(object? sender, AgentTask task)
    {
        // Simple full reload for safety, optimization possible later
        InvokeAsync(async () =>
        {
            await LoadTasks();
            StateHasChanged();
        });
    }

    private async Task LoadTasks()
    {
        var tasks = await AgentService.GetTasksAsync();
        Tasks = tasks.ToList();
    }

    private void HandleDragStart(AgentTask task)
    {
        DraggedTask = task;
    }

    private async Task HandleDrop(Corker.Core.Entities.TaskStatus newStatus)
    {
        if (DraggedTask != null)
        {
            await AgentService.UpdateTaskStatusAsync(DraggedTask.Id, newStatus);
            DraggedTask = null;
            // LoadTasks will be called by the event handler
        }
    }

    private async Task CreateNewTask()
    {
        await AgentService.CreateTaskAsync("New Task", "Description here...");
    }

    public void Dispose()
    {
        AgentService.OnTaskUpdated -= HandleTaskUpdate;
    }
}

<style>
    .kanban-container {
        display: flex;
        gap: 1rem;
        height: 80vh;
    }
    .column {
        flex: 1;
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
    }
    .task-list {
        flex: 1;
        background-color: #e9ecef;
        padding: 0.5rem;
        border-radius: 0.25rem;
        overflow-y: auto;
    }
    .task-card {
        cursor: grab;
    }
</style>
