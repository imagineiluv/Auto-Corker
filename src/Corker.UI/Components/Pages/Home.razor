@page "/"
@using Corker.Core.Entities
@using Corker.Orchestrator.Models
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService

<section class="board-header">
    <div class="board-title">
        <span class="board-project">autonomous-coding</span>
        <h1>Kanban Board</h1>
        <p class="page-subtitle">Track autonomous tasks across planning, execution, and review.</p>
    </div>
    <div class="board-actions">
        <label class="toggle">
            <input type="checkbox" @bind="_showArchived" />
            <span>Show archived</span>
        </label>
        <button class="ghost-button" type="button" @onclick="ReloadAsync">Filter</button>
        <button class="primary-button" type="button" @onclick="OpenCreateTaskModal">+ New Task</button>
    </div>
</section>

<section class="kanban-board">
    @foreach (var column in _columns)
    {
        <div class="kanban-column @GetColumnClass(column.Key)"
             ondragover="event.preventDefault();"
             @ondrop="() => HandleDrop(column.Key)">
            <header class="kanban-column-header">
                <div class="column-title">
                    <h2>@column.Title</h2>
                    <span class="column-count-badge">@column.Tasks.Count</span>
                </div>
                @if (column.Key == "backlog")
                {
                    <div class="column-actions">
                        <button class="icon-button" type="button" @onclick="OpenCreateTaskModal">+</button>
                    </div>
                }
            </header>

            @if (column.Tasks.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“­</div>
                    <p>No tasks yet</p>
                    <span>Add a task to @column.Title</span>
                </div>
            }
            else
            {
                @foreach (var task in column.Tasks)
                {
                    <article class="task-card" draggable="true" @ondragstart="() => HandleDragStart(task)">
                        <div class="task-header">
                            <div class="task-title">@task.Title</div>
                            <span class="pill @task.StatusClass">@task.StatusLabel</span>
                        </div>
                        <p class="task-body">@task.Description</p>
                        @if (task.Progress > 0 && column.Key == "in-progress")
                        {
                            <div class="task-progress">
                                <span>Progress</span>
                                <span>@task.Progress%</span>
                            </div>
                            <div class="progress-bar">
                                <span style="width: @task.Progress%"></span>
                            </div>
                        }
                        <div class="task-footer">
                            <div class="task-tags">
                                @foreach (var tag in task.Tags)
                                {
                                    <span class="pill muted">@tag</span>
                                }
                            </div>
                            <span class="task-time">@task.TimeLabel</span>
                        </div>
                        <div class="task-footer">
                            <span class="pill">@task.Owner</span>
                        </div>
                    </article>
                }
            }
        </div>
    }
</section>

@if (_showCreateModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3>Create New Task</h3>
            <div class="form-group">
                <label>Title</label>
                <input type="text" @bind="_newTaskTitle" placeholder="e.g. Implement Login Page" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea @bind="_newTaskDescription" placeholder="Detailed requirements..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="ghost-button" @onclick="CloseCreateModal">Cancel</button>
                <button class="primary-button" @onclick="SubmitNewTaskAsync">Create</button>
            </div>
        </div>
    </div>
}

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background: #1e1e1e; /* Dark theme default */
        padding: 2rem;
        border-radius: 8px;
        width: 500px;
        color: white;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
    }
    .form-group input, .form-group textarea {
        width: 100%;
        padding: 0.5rem;
        background: #2d2d2d;
        border: 1px solid #3d3d3d;
        color: white;
        border-radius: 4px;
    }
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1rem;
    }

    /* Drag & Drop Styles */
    .task-card[draggable="true"] {
        cursor: grab;
    }
    .task-card[draggable="true"]:active {
        cursor: grabbing;
    }
    .kanban-column {
        transition: background-color 0.2s;
    }
    .kanban-column:hover {
        background-color: rgba(255, 255, 255, 0.02);
    }
</style>

@code {
    private IReadOnlyList<KanbanColumn> _columns = Array.Empty<KanbanColumn>();
    private bool _showArchived;
    private TaskCard? _draggedTask;
    private bool _showCreateModal;
    private string _newTaskTitle = "";
    private string _newTaskDescription = "";

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _columns = await DashboardService.GetKanbanAsync();
    }

    private void OpenCreateTaskModal()
    {
        _newTaskTitle = "";
        _newTaskDescription = "";
        _showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        _showCreateModal = false;
    }

    private async Task SubmitNewTaskAsync()
    {
        if (string.IsNullOrWhiteSpace(_newTaskTitle)) return;

        await DashboardService.CreateTaskAsync(_newTaskTitle, _newTaskDescription);
        _showCreateModal = false;
        await ReloadAsync();
    }

    private void HandleDragStart(TaskCard task)
    {
        _draggedTask = task;
    }

    private async Task HandleDrop(string columnKey)
    {
        if (_draggedTask == null) return;

        var newStatus = columnKey switch
        {
            "backlog" => Corker.Core.Entities.TaskStatus.Pending,
            "in-progress" => Corker.Core.Entities.TaskStatus.InProgress,
            "human-review" => Corker.Core.Entities.TaskStatus.Review,
            "done" => Corker.Core.Entities.TaskStatus.Done,
            _ => _draggedTask.Status
        };

        if (newStatus != _draggedTask.Status)
        {
            await DashboardService.UpdateTaskStatusAsync(_draggedTask.Id, newStatus);
            await ReloadAsync();
        }

        _draggedTask = null;
    }

    private static string GetColumnClass(string columnKey)
    {
        return columnKey switch
        {
            "backlog" => "planning",
            "in-progress" => "in-progress",
            "ai-review" => "ai-review",
            "human-review" => "human-review",
            "done" => "done",
            _ => "planning"
        };
    }
}
