@page "/agent-terminals"
@implements IDisposable
@using Corker.Orchestrator.Models
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService

<section class="page-header">
    <div>
        <span class="page-kicker">Workspace</span>
        <h1>Agent Terminals</h1>
        <p class="page-subtitle">Live command outputs and agent status snapshots.</p>
    </div>
    <div class="page-actions">
        <button class="ghost-button" type="button" @onclick="OpenFileExplorerAsync">File Explorer</button>
        <button class="ghost-button" type="button" @onclick="RestoreSessionAsync">Restore Session</button>
        <button class="primary-button" type="button" @onclick="CreateTerminalAsync">+ New Terminal</button>
    </div>
</section>

<section class="terminal-grid">
    @foreach (var terminal in _terminals)
    {
        <article class="terminal-card">
            <header class="terminal-header">
                <div class="terminal-badges">
                    <span class="pill green">Claude</span>
                    <span class="pill muted">@terminal.Mode</span>
                </div>
                <div class="terminal-title">@terminal.Name</div>
            </header>
            <div class="terminal-preview">
                @foreach (var line in terminal.Lines)
                {
                    <code>@line</code>
                }
            </div>
            <div class="terminal-footer">
                <span class="pill @terminal.StatusClass">@terminal.Status</span>
                <span class="pill muted">@terminal.ActivityLabel</span>
            </div>
        </article>
    }

    <!-- Live Agent Logs -->
    <article class="terminal-card">
        <header class="terminal-header">
            <div class="terminal-badges">
                <span class="pill purple">Agent Loop</span>
                <span class="pill muted">Live</span>
            </div>
            <div class="terminal-title">Main Agent Process</div>
        </header>
        <div class="terminal-preview">
            @foreach (var line in _liveLogs)
            {
                <div class="log-line">@line</div>
            }
        </div>
        <div class="terminal-footer">
            <span class="pill green">Active</span>
            <span class="pill muted">Streaming</span>
        </div>
    </article>
</section>

@code {
    private IReadOnlyList<TerminalSnapshot> _terminals = Array.Empty<TerminalSnapshot>();
    private List<string> _liveLogs = new();

    [Inject] private Corker.Core.Interfaces.IAgentService AgentService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _terminals = await DashboardService.GetTerminalsAsync();
        var logs = await AgentService.GetLogsAsync();
        _liveLogs = logs.ToList();

        AgentService.OnLogReceived += HandleLog;
    }

    public void Dispose()
    {
        if (AgentService != null)
        {
            AgentService.OnLogReceived -= HandleLog;
        }
    }

    private void HandleLog(object? sender, string message)
    {
        InvokeAsync(() =>
        {
            _liveLogs.Add(message);
            StateHasChanged();
        });
    }

    private async Task OpenFileExplorerAsync()
    {
        _terminals = await DashboardService.OpenFileExplorerAsync();
    }

    private async Task RestoreSessionAsync()
    {
        _terminals = await DashboardService.RestoreTerminalSessionAsync();
    }

    private async Task CreateTerminalAsync()
    {
        _terminals = await DashboardService.CreateTerminalAsync();
    }

    private async Task OpenFileExplorerAsync()
    {
        _terminals = await DashboardService.OpenFileExplorerAsync();
    }

    private async Task RestoreSessionAsync()
    {
        _terminals = await DashboardService.RestoreTerminalSessionAsync();
    }

    private async Task CreateTerminalAsync()
    {
        _terminals = await DashboardService.CreateTerminalAsync();
    }
}
