@page "/agent-terminals"
@using Corker.Orchestrator.Models
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService
@implements IDisposable

<section class="page-header">
    <div>
        <span class="page-kicker">Workspace</span>
        <h1>Agent Terminals</h1>
        <p class="page-subtitle">Live command outputs and agent status snapshots.</p>
    </div>
    <div class="page-actions">
        <button class="ghost-button" type="button" @onclick="OpenFileExplorerAsync">File Explorer</button>
        <button class="ghost-button" type="button" @onclick="RestoreSessionAsync">Restore Session</button>
        <button class="primary-button" type="button" @onclick="CreateTerminalAsync">+ New Terminal</button>
    </div>
</section>

<div class="tab-shell">
    <div class="tab-list">
        @foreach (var terminal in _terminals)
        {
            <button class="tab-pill @(terminal == _activeTerminal ? "active" : "")"
                    @onclick="() => SelectTerminal(terminal)">
                @terminal.Name
            </button>
        }
    </div>
</div>

@if (_activeTerminal != null)
{
    <article class="terminal-card" style="height: 60vh;">
        <header class="terminal-header">
            <div class="terminal-badges">
                <span class="pill green">Claude</span>
                <span class="pill muted">@_activeTerminal.Mode</span>
            </div>
            <div class="terminal-title">@_activeTerminal.Name</div>
        </header>
        <div class="terminal-preview" style="flex: 1; overflow-y: auto;">
            @foreach (var line in _activeTerminal.Lines)
            {
                <div style="font-family: monospace;">
                    <span style="color: #5c7cff;">$</span> <code>@line</code>
                </div>
            }
        </div>
        <div class="terminal-footer">
            <span class="pill @_activeTerminal.StatusClass">@_activeTerminal.Status</span>
            <span class="pill muted">@_activeTerminal.ActivityLabel</span>
        </div>
    </article>
}
else
{
    <div class="empty-state">
        <div class="empty-icon">ðŸ’»</div>
        <p>No active terminals</p>
        <button class="primary-button" @onclick="CreateTerminalAsync">Create Terminal</button>
    </div>
}

@code {
    private IReadOnlyList<TerminalSnapshot> _terminals = Array.Empty<TerminalSnapshot>();
    private TerminalSnapshot? _activeTerminal;

    protected override async Task OnInitializedAsync()
    {
        DashboardService.OnStateChanged += HandleStateChanged;
        await LoadTerminalsAsync();
    }

    public void Dispose()
    {
        DashboardService.OnStateChanged -= HandleStateChanged;
    }

    private async void HandleStateChanged()
    {
        await LoadTerminalsAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadTerminalsAsync()
    {
        _terminals = await DashboardService.GetTerminalsAsync();
        // Keep active terminal selected if possible
        if (_activeTerminal == null && _terminals.Count > 0)
        {
            _activeTerminal = _terminals[0];
        }
        else if (_activeTerminal != null)
        {
            _activeTerminal = _terminals.FirstOrDefault(t => t.Name == _activeTerminal.Name) ?? _terminals.FirstOrDefault();
        }
    }

    private void SelectTerminal(TerminalSnapshot terminal)
    {
        _activeTerminal = terminal;
    }

    private async Task OpenFileExplorerAsync()
    {
        _terminals = await DashboardService.OpenFileExplorerAsync();
        if (_terminals.Count > 0) _activeTerminal = _terminals[0];
    }

    private async Task RestoreSessionAsync()
    {
        _terminals = await DashboardService.RestoreTerminalSessionAsync();
        if (_terminals.Count > 0) _activeTerminal = _terminals[0];
    }

    private async Task CreateTerminalAsync()
    {
        _terminals = await DashboardService.CreateTerminalAsync();
        if (_terminals.Count > 0) _activeTerminal = _terminals[0];
    }
}
