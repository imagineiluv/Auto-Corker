@page "/agent-terminals"
@using Corker.Orchestrator.Models
@inject Corker.Orchestrator.Services.WorkspaceDashboardService DashboardService
@inject IJSRuntime JS

<section class="page-header">
    <div>
        <span class="page-kicker">Workspace</span>
        <h1>Agent Terminals</h1>
        <p class="page-subtitle">Live command outputs and agent status snapshots.</p>
    </div>
    <div class="page-actions">
        <button class="ghost-button" type="button" @onclick="OpenFileExplorerAsync">File Explorer</button>
        <button class="ghost-button" type="button" @onclick="RestoreSessionAsync">Restore Session</button>
        <button class="primary-button" type="button" @onclick="CreateTerminalAsync">+ New Terminal</button>
    </div>
</section>

<div class="tab-shell">
    <div class="tab-list">
        @foreach (var terminal in _terminals)
        {
            <button class="tab-pill @(terminal == _activeTerminal ? "active" : "")"
                    @onclick="() => SelectTerminal(terminal)">
                @terminal.Name
            </button>
        }
    </div>
</div>

@if (_activeTerminal != null)
{
    <article class="terminal-card full-height">
        <header class="terminal-header">
            <div class="terminal-badges">
                <span class="pill green">Claude</span>
                <span class="pill muted">@_activeTerminal.Mode</span>
            </div>
            <div class="terminal-title">@_activeTerminal.Name</div>
        </header>
        <div class="terminal-preview" id="terminal-output">
            @foreach (var line in _activeTerminal.Lines)
            {
                <div class="terminal-line">
                    <span class="prompt">$</span> <code>@line</code>
                </div>
            }
        </div>
        <div class="terminal-footer">
            <span class="pill @_activeTerminal.StatusClass">@_activeTerminal.Status</span>
            <span class="pill muted">@_activeTerminal.ActivityLabel</span>
        </div>
    </article>
}
else
{
    <div class="empty-state">
        <div class="empty-icon">ðŸ’»</div>
        <p>No active terminals</p>
        <button class="primary-button" @onclick="CreateTerminalAsync">Create Terminal</button>
    </div>
}

<style>
    .full-height {
        height: calc(100vh - 240px);
        display: flex;
        flex-direction: column;
    }
    .terminal-preview {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: rgba(10, 10, 12, 0.5);
    }
    .terminal-line {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .prompt {
        color: #5c7cff;
        margin-right: 8px;
        user-select: none;
    }
</style>

@code {
    private IReadOnlyList<TerminalSnapshot> _terminals = Array.Empty<TerminalSnapshot>();
    private TerminalSnapshot? _activeTerminal;

    protected override async Task OnInitializedAsync()
    {
        _terminals = await DashboardService.GetTerminalsAsync();
        if (_terminals.Count > 0)
        {
            _activeTerminal = _terminals[0];
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_activeTerminal != null)
        {
            try
            {
                await JS.InvokeVoidAsync("window.scrollToBottom", "terminal-output");
            }
            catch
            {
                // Ignore JS errors during navigation
            }
        }
    }

    private void SelectTerminal(TerminalSnapshot terminal)
    {
        _activeTerminal = terminal;
    }

    private async Task OpenFileExplorerAsync()
    {
        _terminals = await DashboardService.OpenFileExplorerAsync();
        if (_terminals.Count > 0) _activeTerminal = _terminals[0];
    }

    private async Task RestoreSessionAsync()
    {
        _terminals = await DashboardService.RestoreTerminalSessionAsync();
        if (_terminals.Count > 0) _activeTerminal = _terminals[0];
    }

    private async Task CreateTerminalAsync()
    {
        _terminals = await DashboardService.CreateTerminalAsync();
        if (_terminals.Count > 0) _activeTerminal = _terminals[0];
    }
}
